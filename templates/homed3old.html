{% extends "layout.html" %}
{% block content%}
<main class="mt-0 mb-0">
  <section class="main-section-1" style="height: 92vh; width: 95 vw;">
    <div class="pt-4">
      <h1 style="font-size:5vw" class="text-center text-light fw-bolder">LIBS ANALYZER</h1>
    </div>
    <div class="mt-3">
      <div class="d-flex  justify-content-evenly flex-row bd-highlight mb-3">

        <div class="p-2 bd-highlight"><img width="300vw" height="300vw"
            src="{{ url_for('static', filename='/media/Group11.jpg') }}" alt=""></div>
        <div class="my-auto p-2 bd-highlight b"><a class="btn btn-lg btn-green fw-bold" href="#section-2">GET
            STARTED</a></div>
        <div class="p-2 bd-highlight" id="my_p1"><img width="300vw" height="300vw"
            src="{{ url_for('static', filename='/media/Group12.jpg') }}" alt=""></div>
      </div>
    </div>
  </section>

<section id="section-2" class="section-2" style="height: 92vh; width: 95 vw;">
<form action="/" method="POST" enctype=multipart/form-data >
  {{form.hidden_tag()}}
  {{form.lower_wave.label()}}
  {{form.lower_wave}} <br>
  {% if form.lower_wave.errors %}
          <div class="invalid-feedback">
            {% for error in form.lower_wave.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div> 
          <br><br>                               
  {% endif %}

  {{form.upper_wave.label()}}
  {{form.upper_wave}} <br>
  {% if form.upper_wave.errors %}
          <div class="invalid-feedback">
            {% for error in form.upper_wave.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div>
          <br><br>                                    
  {% endif %}

  {{form.baseline_intensity.label()}}
  {{form.baseline_intensity}} <br>
  {% if form.baseline_intensity.errors %}
          <div class="invalid-feedback">
            {% for error in form.baseline_intensity.errors %}
                <span>{{ error }}</span>
            {% endfor %}
            </div>
            <br><br>          
  {% endif %}

  <span class="anchor" id="s_section-3"></span>
    <div class="d-flex flex-column s2">
      <div class="p-0">
        {{form.input_file(id = 'file',onchange="plotGraph()")}}
        
        <button type ="button" id="file_input" onclick="clickHandler()" 
        class="btn btn-lg section-2-btn" style="color: #000000 ;">Input
          Spectral Data</button>
      </div>
      <div class="p-0">
        <div class="graphc"><div id="graphContainer"></div></div>
      </div>
      <div class="p-0">
        <button type= 'button' class="btn btn-lg section-2-btn-next" style="color: #000000 ;">NEXT</button>
      </div>

    </div>
  </section>

  
  <section class="container">
    <h2>Element Selector</h2>
    {{form.r_cutoff.label()}}
    {{form.r_cutoff}} <br>
    {% if form.r_cutoff.errors %}
          <div class="invalid-feedback">
            {% for error in form.r_cutoff.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div>
          <br><br>             
    {% endif %}

    {{form.l_cutoff.label()}}
    {{form.l_cutoff}} <br>
    {% if form.l_cutoff.errors %}
          <div class="invalid-feedback">
            err
            {% for error in form.l_cutoff.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div>
          <br><br>   
    {% endif %}

    {{form.n_peaks.label()}}
    {{form.n_peaks}} <br>
    {% if form.n_peaks.errors %}
          <div class="invalid-feedback">
            {% for error in form.n_peaks.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div>
          <br><br>                        
    {% endif %}
  
    {{form.PS}}
    {% if form.PS.errors %}
          <div class="invalid-feedback">
            {% for error in form.PS.errors %}
                <span>{{ error }}</span>
            {% endfor %}
          </div>
          <br><br>                        
    {% endif %}
  </section>

  <section>
    {{form.selected_elements.label}}
    <br>
    {{form.selected_elements()}}
  </section>
  {{form.submit}}
</form>
<section id="test"></section>
<section id="test2"></section>
</main>
{% endblock content%}


{% block JScript%}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.plot.ly/plotly-2.25.2.min.js" charset="utf-8"></script>
<script>
  
  function plotGraph() {

    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];

    if (file) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const content = event.target.result;
        // document.write(content)
        const lines = content.split(/\r?\n/);
        const data = [];
        const x =[];
        const y =[];
        headings = lines[0];
        //console.log(event.target.result);
        // console.log(lines.length)
        //console.log(lines[0])

        for (let i = 1; i < (lines.length-1); i++) {  // Start from index 1 to skip header
          const line = lines[i].split(',');
          // console.log(line);
          const rx = line[0];
          const ry = line[1];
          // console.log(rx,ry, i);
          const v_x = parseFloat(rx);
          const v_y = parseFloat(ry);
          if (!isNaN(v_x) && !isNaN(v_y)) {
            x.push(v_x);
            y.push(v_y);
          }
        }
        drawChart(data,x,y);
        DrawChart2(lines, "test2")
      };
      reader.readAsText(file);
    }
  }

  function drawChart(data,x,y) {
    Plotly.newPlot("test", [x,y], {
	margin: { t: 0 } } );
  }
  function clickHandler() {
    document.getElementById('file').click()
  }
  let element = document.getElementById('file_input')

  function DrawChart2(data,idvar){
    Plotly.newPlot(idvar,data, {
	margin: { t: 0 } } );
  }
</script>
{% endblock JScript%}